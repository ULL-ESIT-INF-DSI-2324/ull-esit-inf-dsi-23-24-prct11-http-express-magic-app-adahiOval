<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>practica10</title><meta name="description" content="Documentation for practica10"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">practica10</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h2>practica10</h2></div><div class="tsd-panel tsd-typography"><a id="md:introducción" class="tsd-anchor"></a><h2><a href="#md:introducción">Introducción</a></h2><p>En esta práctica se presenta un ejercicio para familiarizarnos con el manejo de Express y las peticiones HTTP, así 
como con los principios SOLID. Se ha desarrollado el ejercicio en la carpeta <code>src</code> que implementa un server
utilizando Express, y sus correspondientes pruebas en la carpeta <code>test</code>.</p>
<p>Para la instalación de las dependencias necesarias para hacer funcionar el código solo es necesario el comando:</p>
<pre><code class="language-bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">install</span>
</code><button>Copy</button></pre>
<p>Para el testeo y las peticiones posibles los objetos JSON que estén adjuntos a las peticiones representando una carta deben de ser de esta manera en caso de ser una carta normal:</p>
<pre><code class="language-JSON"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;ID&quot;</span><span class="hl-1">: </span><span class="hl-4">2</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Name&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;test2&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Cost&quot;</span><span class="hl-1">: </span><span class="hl-4">3</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Color&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;verde&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;instantaneo&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Rarity&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;comun&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Text&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;hello&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Price&quot;</span><span class="hl-1">: </span><span class="hl-4">8</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>En caso de ser una criatura:</p>
<pre><code class="language-JSON"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;ID&quot;</span><span class="hl-1">: </span><span class="hl-4">1</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Name&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;test1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Cost&quot;</span><span class="hl-1">: </span><span class="hl-4">3</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Color&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;azul&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;criatura&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Rarity&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;comun&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Text&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;hello&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Price&quot;</span><span class="hl-1">: </span><span class="hl-4">8</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;Stats&quot;</span><span class="hl-1">: {</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;fuerza&quot;</span><span class="hl-1">: </span><span class="hl-4">5</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;resistencia&quot;</span><span class="hl-1">: </span><span class="hl-4">5</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>Y en caso de ser un Planeswalker:</p>
<pre><code class="language-JSON"><span class="hl-1">{</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;ID&quot;</span><span class="hl-1">: </span><span class="hl-4">3</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Name&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;test3&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Cost&quot;</span><span class="hl-1">: </span><span class="hl-4">3</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Color&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;multicolor&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Type&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;planeswalker&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Rarity&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;comun&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Text&quot;</span><span class="hl-1">: </span><span class="hl-2">&quot;hello&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Price&quot;</span><span class="hl-1">: </span><span class="hl-4">8</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">&quot;Loyalty&quot;</span><span class="hl-1">: </span><span class="hl-4">8</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:objetivos" class="tsd-anchor"></a><h2><a href="#md:objetivos">Objetivos</a></h2><p>Los objetivos de esta práctica son la familiarización con Express, así como los principios SOLID de 
programación orientada a objetos y también la implementación de coveralls en nuestro código, el patrón 
callback y los sockets y la programación asincrona con la api asincrona de Node para el sistema de archivos. </p>
<a id="md:clases" class="tsd-anchor"></a><h2><a href="#md:clases">Clases</a></h2><p>Las clases desarrolladas para esta práctica son las siguientes, como en la práctica anterior:</p>
<ul>
<li>Card: Clase base de los distintos tipos de cartas, con sus correspondientes atributos</li>
<li>CardCollection: Coleccion de cartas.</li>
<li>CardCollectionReader: Lector de Coleccion de cartas a partir de un directorio de un usuario</li>
<li>CardCollectionPrinter: Printer de una coleccion de cartas dada</li>
<li>CardCollectionWriter: Escritor de la coleccion de cartas en el directorio del usuario de la misma</li>
<li>CardReader: Lector de carta individual a partir de un objeto JSON</li>
</ul>
<a id="md:card" class="tsd-anchor"></a><h3><a href="#md:card">Card</a></h3><p>Esta es la clase base de los distintos tipos de cartas. Es una clase abstracta cuyo constructor tiene los atributos mínimos compartidos por todas las cartas. De ella se crea una clase diferente para cada tipo de carta:</p>
<ul>
<li>Tierra</li>
<li>Encantamiento</li>
<li>Conjuro</li>
<li>Instantaneo</li>
<li>Artefacto</li>
<li>Criatura: Con el atributo adicional <code>stats</code></li>
<li>Planeswalker: Con el atributo adicional <code>loyalty</code></li>
</ul>
<p>También se define un método abstracto <code>print()</code> que cada una de las clases hijas implementa propiamente.</p>
<a id="md:cardcollection" class="tsd-anchor"></a><h3><a href="#md:cardcollection">CardCollection</a></h3><p>Esta es la clase que representa una colección de cartas de un usuario dado. Su constructor recibe un array de objetos tipo <code>Card</code> y un string con el nombre de usuario. Dentro de esta clase se encuentran los siguientes métodos:</p>
<ul>
<li><code>addCard</code>: Este es el método para añadir una carta a la colección, se le pasa una carta por parámetro y la añade al array de cartas de la colección</li>
<li><code>updateCard</code>: Este método modifica una carta existente, se le pasa una carta y elimina la carta existente con el mismo ID y añade la nueva carta dada por parametro.</li>
<li><code>deleteCard</code>: Este método elimina una carta de la colección, se le pasa un ID por parámetro que comprueba si existe primero y luego filtra la colección para que devuelva un nuevo array con los IDs que no coinciden.</li>
<li><code>showCard</code>: Este método muestra la información de una sola carta por consola, se le pasa un ID que busca en la colección e invoca el método print de la carta concreta.</li>
<li><code>listCollection</code>: Este método lista todas las cartas de la colección, para ello crea un objeto <code>CardCollectionPrinter</code> que toma la propia coleccion, y luego invoca a su método print que a su vez invoca el metodo print de todas las cartas de la colección.</li>
</ul>
<a id="md:cardcollectionreader" class="tsd-anchor"></a><h3><a href="#md:cardcollectionreader">CardCollectionReader</a></h3><p>Esta clase se encarga de leer las cartas del directorio de un usuario dado. Para ello, se le pasa el nombre de usuario en el constructor, que se encarga de crear la ruta relativa al directorio del usuario utilizando el módulo <code>path</code> de la siguiente manera:</p>
<pre><code class="language-typescript"><span class="hl-0">constructor</span><span class="hl-1">(</span><span class="hl-5">private</span><span class="hl-1"> </span><span class="hl-5">user</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-5">callback</span><span class="hl-1">: (</span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">__dirname</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">dirname</span><span class="hl-1">(</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-9">import</span><span class="hl-1">.</span><span class="hl-5">meta</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">).</span><span class="hl-5">pathname</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">fatherdir</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(</span><span class="hl-5">__dirname</span><span class="hl-1">, </span><span class="hl-2">&#39;..&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">sourcedir</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">resolve</span><span class="hl-1">(</span><span class="hl-5">fatherdir</span><span class="hl-1">, </span><span class="hl-2">&#39;..&#39;</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">route</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-5">sourcedir</span><span class="hl-1">, </span><span class="hl-2">`src/database/users/</span><span class="hl-7">${</span><span class="hl-7">this</span><span class="hl-10">.</span><span class="hl-5">user</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">readDir</span><span class="hl-1">((</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">){</span><br/><span class="hl-1">        </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<p>Luego hace uso de un método <code>readDir</code> que lee todo el directorio con la ruta anterior, probando su existencia primero, y para cada archivo encontrado, llama al método <code>JSON.parse</code> y crea un objeto <code>CardReader</code> con ese resultado, luego hace uso del método <code>returnCard</code> del objeto <code>CardReader</code> que devuelve una Carta ya creada y la añade al array de la colección:</p>
<pre><code class="language-typescript"><span class="hl-1">  </span><span class="hl-0">readDir</span><span class="hl-1">(</span><span class="hl-5">callback</span><span class="hl-1">: (</span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">, </span><span class="hl-5">success</span><span class="hl-1">: </span><span class="hl-6">number</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span><span class="hl-1">): </span><span class="hl-7">void</span><span class="hl-1"> {</span><br/><br/><span class="hl-1">    </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">readdir</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">route</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">cards</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1">, </span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">cards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> == </span><span class="hl-4">0</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">, </span><span class="hl-4">0</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-5">cardCount</span><span class="hl-1"> = </span><span class="hl-4">0</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-5">cards</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-5">card</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">readFile</span><span class="hl-1">(</span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-7">this</span><span class="hl-10">.</span><span class="hl-5">route</span><span class="hl-7">}</span><span class="hl-2">/</span><span class="hl-7">${</span><span class="hl-5">card</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">, </span><span class="hl-2">&#39;utf-8&#39;</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">content</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">              </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">data</span><span class="hl-1">: </span><span class="hl-6">CardShape</span><span class="hl-1"> = </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-5">content</span><span class="hl-1">);</span><br/><span class="hl-1">              </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">reader</span><span class="hl-1">: </span><span class="hl-6">CardReader</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">CardReader</span><span class="hl-1">(</span><span class="hl-5">data</span><span class="hl-1">);</span><br/><span class="hl-1">        </span><br/><span class="hl-1">              </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">collection</span><span class="hl-1">.</span><span class="hl-0">push</span><span class="hl-1">(</span><span class="hl-5">reader</span><span class="hl-1">.</span><span class="hl-0">returnCard</span><span class="hl-1">());</span><br/><span class="hl-1">              </span><span class="hl-5">cardCount</span><span class="hl-1">++;</span><br/><span class="hl-1">              </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">cardCount</span><span class="hl-1"> === </span><span class="hl-5">cards</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">) {</span><br/><span class="hl-1">                </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">, </span><span class="hl-4">0</span><span class="hl-1">)</span><br/><span class="hl-1">              }</span><br/><span class="hl-1">            });</span><br/><span class="hl-1">          });</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      } </span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<p>Al ser todo código asíncrono y ser este el primer paso de cualquier ejecución del programa, ésta es la clase &quot;principal&quot; de la que se anida el resto del código en cada acción. Por ende, todo el código principal de la aplicación utiliza el patrón callback chaining para funcionar y hacer uso de la API asíncrona de Node.</p>
<a id="md:cardcollectionwriter" class="tsd-anchor"></a><h3><a href="#md:cardcollectionwriter">CardCollectionWriter</a></h3><p>Esta es la clase encargada de escribir los resultados de las operaciones sobre la colección en el directorio del usuario inicial. Para ello, hace uso del método <code>write()</code> que primero borra todos los archivos del directorio del usuario, para luego escribir las cartas de la colección cada una en un archivo <code>JSON</code> separado. Se ha optado por esta forma ya que simplifica mucho el manejo del sistema de archivos del ordenador.</p>
<pre><code class="language-typescript"><span class="hl-0">write</span><span class="hl-1">(): </span><span class="hl-7">void</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-11">// Limpia el directorio antes de escribir la colección</span><br/><span class="hl-1">    </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-0">clean</span><span class="hl-1">((</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">){</span><br/><span class="hl-1">        </span><span class="hl-9">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-11">// Escribe cada carta en un archivo JSON en el directorio</span><br/><span class="hl-1">        </span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">collection</span><span class="hl-1">.</span><span class="hl-5">collection</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-5">card</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">cardPath</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">route</span><span class="hl-1">, </span><span class="hl-2">`</span><span class="hl-7">${</span><span class="hl-5">card</span><span class="hl-10">.</span><span class="hl-5">name</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">);</span><br/><span class="hl-1">          </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">writeFile</span><span class="hl-1">(</span><span class="hl-5">cardPath</span><span class="hl-1">, </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-5">card</span><span class="hl-1">), (</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">              </span><span class="hl-9">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1">);</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">          });</span><br/><span class="hl-1">        });</span><br/><span class="hl-1">      } </span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<p>Como se puede observar, se utiliza un método &#39;clean&#39; al que se le pasa un manejador por parámetro, esto es porque necesitamos esperar a borrar los archivos mediante la API asincrona de Node y para asegurarnos de ello debemos usar el patron callback nuevamente. El método <code>clean</code> luce de la siguiente manera:</p>
<pre><code class="language-typescript"><span class="hl-1">  </span><span class="hl-0">clean</span><span class="hl-1">(</span><span class="hl-5">callback</span><span class="hl-1">: (</span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-7">void</span><span class="hl-1">): </span><span class="hl-7">void</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">readdir</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">route</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">files</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-9">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1">);</span><br/><span class="hl-1">      } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">files</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1"> == </span><span class="hl-4">0</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">          </span><span class="hl-7">let</span><span class="hl-1"> </span><span class="hl-5">fileCount</span><span class="hl-1"> = </span><span class="hl-4">0</span><span class="hl-1">;</span><br/><span class="hl-1">          </span><span class="hl-5">files</span><span class="hl-1">.</span><span class="hl-0">forEach</span><span class="hl-1">((</span><span class="hl-5">file</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">filePath</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-7">this</span><span class="hl-1">.</span><span class="hl-5">route</span><span class="hl-1">, </span><span class="hl-5">file</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-11">// Elimina cada archivo en el directorio</span><br/><span class="hl-1">            </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">unlink</span><span class="hl-1">(</span><span class="hl-5">filePath</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">              </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">                </span><span class="hl-9">throw</span><span class="hl-1"> </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">.</span><span class="hl-5">message</span><span class="hl-1">);</span><br/><span class="hl-1">              } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-5">fileCount</span><span class="hl-1">++;</span><br/><span class="hl-1">                </span><span class="hl-11">// Si todos los archivos han sido eliminados, llama al callback sin errores</span><br/><span class="hl-1">                </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">fileCount</span><span class="hl-1"> === </span><span class="hl-5">files</span><span class="hl-1">.</span><span class="hl-5">length</span><span class="hl-1">) {</span><br/><span class="hl-1">                  </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">                }</span><br/><span class="hl-1">              }</span><br/><span class="hl-1">            });</span><br/><span class="hl-1">          });</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<a id="md:magic-express-serverts" class="tsd-anchor"></a><h2><a href="#md:magic-express-serverts">magic-express-server.ts</a></h2><p>Este es el archivo principal donde se ha desarrollado la práctica. Se ha usado <code>express</code> para crear el server y <code>bodyParser</code> para que el server fuera capaz de acceder al cuerpo de las request, también se ha usado <code>Thunder Client</code> para hacer peticiones HTTP al servidor y probar su funcionamiento. </p>
<pre><code class="language-typescript"><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">server</span><span class="hl-1"> = </span><span class="hl-0">express</span><span class="hl-1">();</span><br/><br/><span class="hl-5">server</span><span class="hl-1">.</span><span class="hl-0">use</span><span class="hl-1">(</span><span class="hl-5">bodyParser</span><span class="hl-1">.</span><span class="hl-0">json</span><span class="hl-1">());</span>
</code><button>Copy</button></pre>
<p>Todas las peticiones serán en la ruta <code>/cards</code>, por ende se abstendrá de mencionar la ruta de nuevo, solo los cambios en los verbos HTTP. También todas los manejadores para las peticiones siguen el mismo formato:</p>
<ol>
<li>Comprobación de la query string para el usuario</li>
<li>Comprobación de la query string para los demás argumentos necesarios (ID)</li>
<li>Comprobación del cuerpo de la petición para ajuste de forma</li>
</ol>
<p>De la misma manera las respuestas también siguen siempre el mismo formato, con un parámetro <code>success</code> que puede ser <code>true</code> o <code>false</code> y con otro parámetro que puede ser <code>cards</code>, <code>card</code> o <code>message</code> según el tipo de petición que estemos haciendo y si es satisfactoria o no. En caso de una respuesta insatisfactoria siempre se devolverá al usuario una respuesta con este formato:</p>
<pre><code class="language-JSON"><span class="hl-1">{</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;success&quot;</span><span class="hl-1">: </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">&quot;message&quot;</span><span class="hl-1">: </span><span class="hl-12">&#39;~Error</span><span class="hl-1"> </span><span class="hl-12">message~&#39;</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>En todos los casos para el manejo del sistema de archivos, las cartas y las colecciones el servidor hace uso de la estructura de clases creada en anteriores prácticas y discutida anteriormente en este informe.</p>
<a id="md:peticiones-get" class="tsd-anchor"></a><h3><a href="#md:peticiones-get">Peticiones GET</a></h3><p>En primer lugar, se define el comportamiento del server ante una petición tipo <code>get</code>. Este verbo tiene la particularidad de que se usa de manera doble, es decir, si se le proporciona en la <em>query string</em> un <strong>ID</strong> al servidor este devolverá una respuesta que además del parámetro success tendrá un parámetro <code>card</code> con la carta encontrada con el <strong>ID</strong> dado en la <em>query string</em>. En caso contrario, se listarán todas las cartas del usuario y se devolverá una respuesta con <code>success</code> y <code>cards</code>, siendo cards el array con todas las cartas del usuario dado. Para distinguir, se comprueba si la <em>query string</em> tiene un parámetro <strong>ID</strong> y se ejecuta un código u otro según el caso. Pongamos el ejemplo del código sin <strong>ID</strong> en la <em>query string</em>:</p>
<pre><code class="language-typescript"><span class="hl-9">if</span><span class="hl-1">(!</span><span class="hl-5">req</span><span class="hl-1">.</span><span class="hl-5">query</span><span class="hl-1">.</span><span class="hl-5">id</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">reader</span><span class="hl-1">: </span><span class="hl-6">CardCollectionReader</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">CardCollectionReader</span><span class="hl-1">(</span><span class="hl-5">req</span><span class="hl-1">.</span><span class="hl-5">query</span><span class="hl-1">.</span><span class="hl-5">user</span><span class="hl-1"> </span><span class="hl-9">as</span><span class="hl-1"> </span><span class="hl-6">string</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">err</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">collection</span><span class="hl-1">: </span><span class="hl-6">CardCollection</span><span class="hl-1"> = </span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">CardCollection</span><span class="hl-1">(</span><span class="hl-5">reader</span><span class="hl-1">.</span><span class="hl-0">getCollection</span><span class="hl-1">(), </span><span class="hl-5">reader</span><span class="hl-1">.</span><span class="hl-0">getUser</span><span class="hl-1">());</span><br/><span class="hl-1">      </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">userCards</span><span class="hl-1"> = </span><span class="hl-5">collection</span><span class="hl-1">.</span><span class="hl-0">getCards</span><span class="hl-1">();</span><br/><span class="hl-1">      </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">        </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">,</span><br/><span class="hl-1">        </span><span class="hl-5">cards:</span><span class="hl-1"> </span><span class="hl-5">userCards</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>Como se puede observar se hace uso de la estructura de clases creada en anteriores prácticas y discutida anteriormente.</p>
<a id="md:peticiones-post" class="tsd-anchor"></a><h3><a href="#md:peticiones-post">Peticiones POST</a></h3><p>Las peticiones tipo <code>POST</code> se atribuyen a una solicitud de creación de cartas para un usuario concreto. Por ello, se toman las mismas medidas y se comprueba que la <em>query string</em> contenga un usuario al que asignarle la petición. En el caso de este tipo de peticiones, se requiere también que la petición tenga <code>body</code>, ya que es donde estará definida la carta como un objeto <code>JSON</code> que el servidor parseará y creará en el sistema de archivos. La validez del objeto JSON se comprueba de la siguiente manera:</p>
<pre><code class="language-typescript"><span class="hl-1">  </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">queryCard</span><span class="hl-1">: </span><span class="hl-6">CardShape</span><span class="hl-1"> = </span><span class="hl-5">req</span><span class="hl-1">.</span><span class="hl-5">body</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-9">if</span><span class="hl-1">(!(</span><span class="hl-2">&#39;ID&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Name&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Cost&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Color&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Type&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Rarity&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Text&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">) || !(</span><span class="hl-2">&#39;Price&#39;</span><span class="hl-1"> </span><span class="hl-7">in</span><span class="hl-1"> </span><span class="hl-5">queryCard</span><span class="hl-1">)) {</span><br/><span class="hl-1">    </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">      </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">      </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-2">&#39;Properties missing&#39;</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<p>Una vez comprobada la validez del objeto <code>JSON</code> del cuerpo de la petición se procede a crear la carta a partir de él y añadirla a la colección haciendo uso del método <code>addCard()</code> de la clase <code>CardCollection</code>. Tras ello se crea un objeto <code>CardCollectionWriter</code> a partir de la colección ya modificada, creada originalmente a partir de un objeto <code>CardCollectionReader</code> y se invoca a su método <code>write()</code> que escribe esta colección en el sistema de archivos. Tras ello se devuelve la respuesta basada en el string resultante al añadir la carta a la colección:</p>
<pre><code class="language-typescript"><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">resultString</span><span class="hl-1"> == </span><span class="hl-2">&#39;New card added to the collection!&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">} </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:peticiones-patch" class="tsd-anchor"></a><h3><a href="#md:peticiones-patch">Peticiones PATCH</a></h3><p>Este tipo de peticiones es muy parecido al anterior, ya que el servidor las maneja de forma diferente. También se requiere un usuario y un cuerpo, y además un ID en la <em>query string</em>. Este ID es necesario para reconocer la carta que se va a modificar en la colección. Se utilizan los mismos métodos de parseo y comprobación que en el apartado anterior para demostrar la validez del cuerpo de la petición, y se crea la carta a partir del mismo. Una vez creada se llama al método <code>updateCard</code> de la colección para actualizarla y devuelve un string como resultado. Y de la misma forma que antes se escribe en el sistema de archivos y se devuelve una respuesta al cliente:</p>
<pre><code class="language-typescript"><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">resultString</span><span class="hl-1"> == </span><span class="hl-2">&#39;Card updated in the collection!&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">} </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:peticiones-delete" class="tsd-anchor"></a><h3><a href="#md:peticiones-delete">Peticiones DELETE</a></h3><p>Este es el último tipo de peticiones desarrollado para esta práctica, en ella se requiere un <code>user</code> (como en todas) y un <code>ID</code> en la <em>query string</em>. El servidor procesa la petición de manera que se asegura que existe <strong>user</strong> e <strong>id</strong> en la <em>query string</em> y en caso contrario manda una respuesta insatisfactoria al cliente. En caso de que esté todo lo necesario, lee la colección del usuario con un <code>CardCollectionReader</code>, en caso de haber algún error devuelve una respuesta insatisfactoria al cliente y en caso contrario, crea la colección e invoca al método <code>deleteCard</code> de la misma que devuelve un string resultante y luego escribe de nuevo la colección en el sistema de archivos, ya actualizada. Y devuelve una respuesta, satisfactoria o no, basada en el string resultante del método invocado:</p>
<pre><code class="language-typescript"><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">resultString</span><span class="hl-1"> == </span><span class="hl-2">&#39;Card removed from the collection!&#39;</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">true</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">} </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">res</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-5">success:</span><span class="hl-1"> </span><span class="hl-7">false</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-5">message:</span><span class="hl-1"> </span><span class="hl-5">resultString</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<a id="md:ejercicio-pe" class="tsd-anchor"></a><h2><a href="#md:ejercicio-pe">Ejercicio PE</a></h2><p>En el ejercicio PE de esta semana, se ha trabajado con funciones ya escritas usando la API síncrona de Node para trabajar con el sistema de archivos y se han transformado a funciones asíncronas utilizando el patrón callback y callback chaining. Estas funciones fueron <code>writeCard</code> y <code>readCard</code> que leen y escriben una carta en el sistema de archivos. Ambas crean una ruta a partir de los parámetros dados utilizando el módulo <code>path</code> y ambas reciben un callback como parámetro. En el caso de <code>writeCard</code>, se le pasa un usuario y una carta tipo <code>Card</code> y la escribe como objeto JSON en el sistema de archivos haciendo uso de la API asíncrona de node de esta manera:</p>
<pre><code class="language-typescript"><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">writeCard</span><span class="hl-1"> = (</span><span class="hl-5">user</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1">, </span><span class="hl-5">card</span><span class="hl-1">: </span><span class="hl-6">Card</span><span class="hl-1">, </span><span class="hl-0">callback</span><span class="hl-1">: (</span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">, </span><span class="hl-5">data</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-6">void</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">__dirname</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">dirname</span><span class="hl-1">(</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-9">import</span><span class="hl-1">.</span><span class="hl-5">meta</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">).</span><span class="hl-5">pathname</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">route</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-5">__dirname</span><span class="hl-1">, </span><span class="hl-2">`database/users/</span><span class="hl-7">${</span><span class="hl-5">user</span><span class="hl-7">}</span><span class="hl-2">/</span><span class="hl-7">${</span><span class="hl-5">card</span><span class="hl-10">.</span><span class="hl-5">name</span><span class="hl-7">}</span><span class="hl-2">.json`</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">writeFile</span><span class="hl-1">(</span><span class="hl-5">route</span><span class="hl-1">, </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-5">card</span><span class="hl-1">), (</span><span class="hl-5">err</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1"> (</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-2">`Error al escribir la colección.`</span><span class="hl-1">, </span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">, </span><span class="hl-2">`Escritura realizada correctamente.`</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">}</span>
</code><button>Copy</button></pre>
<p>Como se puede observar se hace uso del patrón callback y se llama al callback con el orden de los argumentos adecuados para el funcionamiento del código asíncrono y se devuelve un string con el resultado (satisfactorio o no) de la operación.</p>
<p>En caso de <code>readCard</code> funciona de la misma manera, solo que haciendo uso de <code>fs.readFile</code> y devolviendo en el callback un objeto tipo <code>Card</code> en caso de ser exitoso:</p>
<pre><code class="language-typescript"><span class="hl-9">export</span><span class="hl-1"> </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-0">readCard</span><span class="hl-1"> = (</span><span class="hl-5">user</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1">, </span><span class="hl-5">card</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1">, </span><span class="hl-0">callback</span><span class="hl-1">: (</span><span class="hl-5">err</span><span class="hl-1">: </span><span class="hl-6">string</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">, </span><span class="hl-5">collection</span><span class="hl-1">: </span><span class="hl-6">Card</span><span class="hl-1"> | </span><span class="hl-6">undefined</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> </span><span class="hl-6">void</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">__dirname</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">dirname</span><span class="hl-1">(</span><span class="hl-7">new</span><span class="hl-1"> </span><span class="hl-0">URL</span><span class="hl-1">(</span><span class="hl-9">import</span><span class="hl-1">.</span><span class="hl-5">meta</span><span class="hl-1">.</span><span class="hl-5">url</span><span class="hl-1">).</span><span class="hl-5">pathname</span><span class="hl-1">);</span><br/><span class="hl-1">    </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">route</span><span class="hl-1"> = </span><span class="hl-5">path</span><span class="hl-1">.</span><span class="hl-0">join</span><span class="hl-1">(</span><span class="hl-5">__dirname</span><span class="hl-1">, </span><span class="hl-2">`database/users/</span><span class="hl-7">${</span><span class="hl-5">user</span><span class="hl-7">}</span><span class="hl-2">/</span><span class="hl-7">${</span><span class="hl-5">card</span><span class="hl-7">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-5">fs</span><span class="hl-1">.</span><span class="hl-0">readFile</span><span class="hl-1">(</span><span class="hl-5">route</span><span class="hl-1">,</span><span class="hl-2">&#39;utf-8&#39;</span><span class="hl-1">, (</span><span class="hl-5">err</span><span class="hl-1">, </span><span class="hl-5">data</span><span class="hl-1">) </span><span class="hl-7">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-9">if</span><span class="hl-1">(</span><span class="hl-5">err</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-2">&quot;Error al leer la carta.&quot;</span><span class="hl-1">, </span><span class="hl-7">undefined</span><span class="hl-1">);</span><br/><span class="hl-1">        } </span><span class="hl-9">else</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-7">const</span><span class="hl-1"> </span><span class="hl-8">content</span><span class="hl-1">: </span><span class="hl-6">Card</span><span class="hl-1"> = </span><span class="hl-8">JSON</span><span class="hl-1">.</span><span class="hl-0">parse</span><span class="hl-1">(</span><span class="hl-5">data</span><span class="hl-1">);</span><br/><span class="hl-1">            </span><span class="hl-0">callback</span><span class="hl-1">(</span><span class="hl-7">undefined</span><span class="hl-1">, </span><span class="hl-5">content</span><span class="hl-1">);</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    })</span><br/><span class="hl-1">  }</span>
</code><button>Copy</button></pre>
<a id="md:pruebas" class="tsd-anchor"></a><h2><a href="#md:pruebas">Pruebas</a></h2><p>En esta práctica se han tenido que desarrollar las pruebas de manera un tanto diferente. En el enunciado, se recomendaba el uso del paquete <code>request</code>, pero al no conseguir hacerlo funcionar y tras investigación por mi parte se decidió pivotar hacia el uso de <code>chai-http</code> ya que existen varios artículos que recomiendan su uso para probar APIs con mocha y chai en typescript/javascript. Se encontraron problemas con la importación y el uso de los módulos necesarios pero tras indagar lo suficiente se encontró una solución para ello. Gracias a eso, se pudieron desarrollar las pruebas satisfactoriamente, que cubren todos los casos posibles en cada uno de los verbos y tipos de peticiones desarrolladas para la práctica, bajo el sistema de archivos en un directorio llamado <code>testuser</code>. </p>
<a id="md:conclusiones" class="tsd-anchor"></a><h2><a href="#md:conclusiones">Conclusiones</a></h2><p>En esta práctica se ha profundizado en el desarrollo de código según los principios SOLID, así como familiarizarse con <code>express</code> y la creación de servidores capaces de recibir peticiones HTTP y devolver lo necesario de cada una, así como de la API Asíncrona de Node.js para el manejo del sistema de archivos, el patrón callback y callback chaining y las peticiones HTTP y los clientes como <code>Thunder Client</code> para emitir estas peticiones. También de como hacer pruebas para un servidor utilizando mocha y chai.</p>
<a id="md:bibliografía" class="tsd-anchor"></a><h2><a href="#md:bibliografía">Bibliografía</a></h2><ul>
<li><a href="https://ull-esit-inf-dsi-2324.github.io/typescript-theory/">Apuntes de la asignatura</a><ul>
<li><a href="https://ull-esit-inf-dsi-2324.github.io/typescript-theory/typescript-solid.html">Principios SOLID</a></li>
</ul>
</li>
<li><a href="https://ull-esit-inf-dsi-2324.github.io/nodejs-theory/">Apuntes de la asignatura sobre Node.js</a><ul>
<li><a href="https://ull-esit-inf-dsi-2324.github.io/nodejs-theory/nodejs-express.html">Express</a></li>
<li><a href="https://ull-esit-inf-dsi-2324.github.io/nodejs-theory/nodejs-http-callback-pattern.html">Callback y CallbackChaining</a></li>
</ul>
</li>
<li><a href="https://www.paradigmadigital.com/dev/testeo-api-rest-mocha-chai-http/">Pruebas con chai-http</a></li>
<li><a href="https://ubuverse.com/introduction-to-node-js-api-unit-testing-with-mocha-and-chai/">Más pruebas con chai-http</a><ul>
<li><a href="https://www.reddit.com/r/node/comments/1af6r52/help_with_chai/">Post de Reddit sobre errores de importación con typescript</a></li>
</ul>
</li>
</ul>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-index-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><h4 class="uppercase">Member Visibility</h4><form><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-private" name="private"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Private</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div><div class="tsd-theme-toggle"><h4 class="uppercase">Theme</h4><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-index-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#md:introducción"><span>Introducción</span></a><a href="#md:objetivos"><span>Objetivos</span></a><a href="#md:clases"><span>Clases</span></a><ul><li><a href="#md:card"><span>Card</span></a></li><li><a href="#md:cardcollection"><span>Card<wbr/>Collection</span></a></li><li><a href="#md:cardcollectionreader"><span>Card<wbr/>Collection<wbr/>Reader</span></a></li><li><a href="#md:cardcollectionwriter"><span>Card<wbr/>Collection<wbr/>Writer</span></a></li></ul><a href="#md:magic-express-serverts"><span>magic-<wbr/>express-<wbr/>server.ts</span></a><ul><li><a href="#md:peticiones-get"><span>Peticiones GET</span></a></li><li><a href="#md:peticiones-post"><span>Peticiones POST</span></a></li><li><a href="#md:peticiones-patch"><span>Peticiones PATCH</span></a></li><li><a href="#md:peticiones-delete"><span>Peticiones DELETE</span></a></li></ul><a href="#md:ejercicio-pe"><span>Ejercicio PE</span></a><a href="#md:pruebas"><span>Pruebas</span></a><a href="#md:conclusiones"><span>Conclusiones</span></a><a href="#md:bibliografía"><span>Bibliografía</span></a></div></details></div><div class="site-menu"><nav class="tsd-navigation"><a href="index.html" class="current"><svg class="tsd-kind-icon" viewBox="0 0 24 24"><use href="assets/icons.svg#icon-1"></use></svg><span>practica10</span></a><ul class="tsd-small-nested-navigation" id="tsd-nav-container" data-base="."><li>Loading...</li></ul></nav></div></div></div><div class="tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div></body></html>